<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kirpputorimme</title>
  <style>
    body { margin:0; font-family: system-ui, sans-serif; background:#fafafa; color:#222; }
    .container { max-width:1000px; margin:auto; padding:20px; }
    h1 { margin-top:10px; }
    /* Haku & suodattimet */
    .filters { display:flex; flex-wrap:wrap; gap:10px; margin:20px 0; }
    .filters input, .filters select { padding:8px; font-size:1rem; }
    /* Kategoriat ja tuotteet */
    .category { margin-bottom:20px; border:1px solid #ccc; border-radius:6px; background:#fff; }
    .category-header { padding:10px; cursor:pointer; background:#eee; font-weight:bold; }
    .products { display:none; padding:10px; display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:20px; }
    .product { background:white; padding:15px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.08); }
    .product img { max-width:100%; height:auto; margin-bottom:10px; }
    .price { font-weight:bold; color:#0a7; }
    .hidden { display:none; }
    .form-button { margin:10px 0; padding:10px 15px; font-size:1rem; }
  </style>
</head>
<body>

<div class="container">
  <h1>Kirpputorimme</h1>
  <p>Hae ja selaa myynnissä olevia tuotteita.</p>

  <!-- Testipainike Formille -->
  <button class="form-button" onclick="window.open('https://docs.google.com/forms/d/e/1FAIpQLSdIDAiTJpmkdyjl1Z-TxRzU10z3ZpO14lJvlZul3QQmIcxVmg/viewform', '_blank')">Lisää tuote</button>

  <!-- Haku -->
  <div class="filters">
    <input type="text" id="search" placeholder="Hae tuotteita...">
    <select id="maxPrice">
      <option value="">Ei hintarajaa</option>
      <option value="5">Alle 5 €</option>
      <option value="10">Alle 10 €</option>
      <option value="20">Alle 20 €</option>
    </select>
  </div>

  <div id="categories"></div>
</div>

<script>
const SHEETS_JSON_URL = "https://opensheet.elk.sh/1wrk1OHqtDSLi7p67WlL-D7EwakeZIXgoH6tfX0gfH70/Tuotteet";

// Haetaan tiedot Sheetsistä
async function fetchProducts() {
  const res = await fetch(SHEETS_JSON_URL);
  const data = await res.json();
  return data.map(r => ({
    name: r['Tuotteen nimi'] || "",
    category: r['Kategoria'] || "Muut",
    price: Number(r['Tuotteen hinta']) || 0,
    description: r['Tuotteen kuvaus'] || "",
    link: r['linkki'] || "",
    image: r['Lisää tuotteen kuva'] || ""
  }));
}

// Piirretään tuotteet kategorioittain
function renderCategories(products) {
  const container = document.getElementById("categories");
  container.innerHTML = "";

  // Ryhmitellään kategoriat
  const categories = {};
  products.forEach(p => {
    if(!categories[p.category]) categories[p.category] = [];
    categories[p.category].push(p);
  });

  for(const cat in categories) {
    const catDiv = document.createElement("div");
    catDiv.className = "category";
    catDiv.innerHTML = `<div class="category-header">${cat} (${categories[cat].length})</div><div class="products"></div>`;
    const prodContainer = catDiv.querySelector(".products");

    categories[cat].forEach(product => {
      const div = document.createElement("div");
      div.className = "product";
      div.innerHTML = `
        ${product.image ? `<img src="${product.image}" alt="${product.name}">` : ""}
        ${product.link ? `<h3><a href="${product.link}" target="_blank">${product.name}</a></h3>` : `<h3>${product.name}</h3>`}
        <p class="price">${product.price} €</p>
        <p>${product.description}</p>
      `;
      prodContainer.appendChild(div);
    });

    // Klikkaus toggle
    catDiv.querySelector(".category-header").addEventListener("click", ()=>{
      prodContainer.style.display = prodContainer.style.display === "none" ? "grid" : "none";
    });

    container.appendChild(catDiv);
  }
}

// Haku
function filterProducts() {
  const search = document.getElementById("search").value.toLowerCase();
  const maxPrice = document.getElementById("maxPrice").value;

  document.querySelectorAll(".category").forEach(cat => {
    let hasVisible = false;
    const prods = cat.querySelectorAll(".product");
    prods.forEach(p => {
      const name = p.querySelector("h3").innerText.toLowerCase();
      const desc = p.querySelector("p:last-child").innerText.toLowerCase();
      const price = Number(p.querySelector(".price").innerText.replace(" €",""));
      let visible = true;
      if(search && !name.includes(search) && !desc.includes(search)) visible = false;
      if(maxPrice && price > Number(maxPrice)) visible = false;
      p.classList.toggle("hidden", !visible);
      if(visible) hasVisible = true;
    });
    cat.style.display = hasVisible ? "block" : "none";
  });
}

// Init
(async function(){
  const products = await fetchProducts();
  renderCategories(products);
  document.getElementById("search").addEventListener("input", filterProducts);
  document.getElementById("maxPrice").addEventListener("change", filterProducts);
})();
</script>

</body>
</html>
